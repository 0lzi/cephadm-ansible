---
# Copyright Red Hat
# SPDX-License-Identifier: Apache-2.0
#
# This playbook configures the Ceph repository.
# It also installs some prerequisites (podman, lvm2, chronyd, cephadm, ...)
#
# Usage:
#
# ansible-playbook -i <inventory host file> cephadm-preflight.yml
#
# You can limit the execution to a set of hosts by using `--limit` option:
#
# ansible-playbook -i <inventory host file> cephadm-preflight.yml --limit <my_osd_group|my_node_name>
#
# You can override variables using `--extra-vars` parameter:
#
# ansible-playbook -i <inventory host file> cephadm-preflight.yml --extra-vars "ceph_origin=rhcs"
#

- name: variables validations
  ansible.builtin.import_playbook: validate/preflight.yml

- hosts: all
  become: true
  gather_facts: true
  vars:
    repos_4_to_disable:
      - rhceph-4-tools-for-rhel-{{ ansible_facts['distribution_major_version'] }}-{{ ansible_facts['architecture'] }}-rpms
      - rhceph-4-mon-for-rhel-{{ ansible_facts['distribution_major_version'] }}-{{ ansible_facts['architecture'] }}-rpms
      - rhceph-4-osd-for-rhel-{{ ansible_facts['distribution_major_version'] }}-{{ ansible_facts['architecture'] }}-rpms
    repos_5_to_disable:
      - rhceph-5-tools-for-rhel-{{ ansible_facts['distribution_major_version'] }}-{{ ansible_facts['architecture'] }}-rpms
    repos_6_to_disable:
      - rhceph-6-tools-for-rhel-{{ ansible_facts['distribution_major_version'] }}-{{ ansible_facts['architecture'] }}-rpms
    packages_to_uninstall:
      - ceph-mds
      - ceph-mgr
      - ceph-mon
      - ceph-osd
      - ceph-radosgw
      - rbd-mirror
  tasks:
    - name: import_role ceph_defaults
      import_role:
        name: ceph_defaults

    - name: redhat family of OS related tasks
      when: ansible_facts['os_family'] == 'RedHat'
      import_tasks: tasks/redhat.yml

    - name: Ubuntu related tasks
      when: ansible_facts['distribution'] == 'Ubuntu'
      import_tasks: tasks/ubuntu.yml

    - name: Debain related tasks
      when: ansible_facts['distribution'] == 'Debian'
      import_tasks: tasks/debian.yml

- name: set insecure container registry in /etc/containers/registries.conf
  ansible.builtin.import_playbook: cephadm-set-container-insecure-registries.yml
  when: set_insecure_registries | default(false) | bool
